<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SpeakRight - Pronunciation Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 20px; }
    h1 { text-align: center; font-size: 26px; margin-bottom: 20px; }
    #inputBox {
        width: 100%; height: 120px; padding: 12px; font-size: 16px;
        border: 1px solid #bbb; border-radius: 8px; resize: none;
    }
    button {
        width: 100%; padding: 14px; background: #000; color: white;
        font-size: 18px; border: none; border-radius: 8px; margin-top: 12px;
    }
    #sentencesBox {
        margin-top: 25px; padding: 15px; background: #fff;
        border-radius: 8px; border: 1px solid #ddd;
    }
    .sentence {
        padding: 10px; font-size: 18px; margin-bottom: 12px; line-height: 30px;
    }
    .correct { color: green; font-weight: bold; }
    .wrong { color: red; font-weight: bold; }
    .unclear { color: orange; font-weight: bold; }

    #correctionBox {
        display: none; margin-top: 10px; padding: 10px; background: #ffecec;
        color: #b30000; border: 1px solid #ffb3b3; border-radius: 6px; font-size: 16px;
    }

    #progressBarContainer {
        width: 100%; height: 12px; background: #ddd;
        border-radius: 8px; margin-top: 10px;
    }
    #progressBar {
        width: 0%; height: 100%; background: #4caf50; border-radius: 8px;
    }
</style>
</head>
<body>

<h1>SpeakRight – Pronunciation Trainer</h1>

<textarea id="inputBox" placeholder="Paste your English text here..."></textarea>
<button id="processBtn">Split Into Sentences</button>

<div id="sentencesBox"></div>
<div id="correctionBox"></div>

<div id="progressBarContainer"><div id="progressBar"></div></div>

<button id="startSentenceBtn" style="display:none;">Start Reading This Sentence</button>

<script>
/* ------------------ GLOBALS ------------------ */
let sentences = [];
let currentIndex = 0;
let recognition;

/* ------------------ SPLIT SENTENCES ------------------ */
document.getElementById("processBtn").onclick = () => {
    const text = document.getElementById("inputBox").value.trim();
    if (!text) return;

    sentences = text.match(/[^.!?]+[.!?]?/g) || [];
    const box = document.getElementById("sentencesBox");
    box.innerHTML = "";

    sentences.forEach((s, i) => {
        box.innerHTML += `<div class="sentence" id="sentence-${i}">${s}</div>`;
    });

    currentIndex = 0;
    updateProgress();
    document.getElementById("startSentenceBtn").style.display = "block";
};

/* ------------------ START LISTENING ------------------ */
document.getElementById("startSentenceBtn").onclick = () => {
    startListening();
};

function startListening() {
    const targetSentence = sentences[currentIndex];

    if (!("webkitSpeechRecognition" in window)) {
        alert("Speech recognition not supported on this browser.");
        return;
    }

    recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.start();

    document.getElementById("startSentenceBtn").innerText = "Listening… Speak now";

    recognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript.toLowerCase();
        evaluateSentence(targetSentence, spoken);
    };

    recognition.onend = () => {
        document.getElementById("startSentenceBtn").innerText = "Start Reading This Sentence";
    };
}

/* ------------------ EVALUATE ------------------ */
function evaluateSentence(target, spoken) {
    const targetWords = target.toLowerCase().split(" ");
    const spokenWords = spoken.toLowerCase().split(" ");

    let resultHTML = "";
    let wrongWord = null;
    let correctPronunciation = null;

    let spokenIndex = 0;

    targetWords.forEach((word) => {
        const cleanWord = word.replace(/[^a-z]/g, "");

        const spokenMatch = spokenWords[spokenIndex] || "";

        if (spokenMatch === cleanWord) {
            resultHTML += `<span class='correct'>${word} </span>`;
            spokenIndex++;
        }
        else if (spokenMatch && similarity(cleanWord, spokenMatch) > 0.7) {
            resultHTML += `<span class='unclear'>${word} </span>`;
            spokenIndex++;
        }
        else {
            resultHTML += `<span class='wrong'>${word} </span>`;
            wrongWord = spokenMatch || "(missing)";
            correctPronunciation = cleanWord;
        }
    });

    document.getElementById(`sentence-${currentIndex}`).innerHTML = resultHTML;

    if (wrongWord) {
        showCorrection(wrongWord, correctPronunciation);
        speakCorrectWord(correctPronunciation);
        return;
    }

    moveToNextSentence();
}

/* ------------------ SIMILARITY CHECK ------------------ */
function similarity(a, b) {
    let matches = 0;
    let length = Math.min(a.length, b.length);
    for (let i = 0; i < length; i++) {
        if (a[i] === b[i]) matches++;
    }
    return matches / a.length;
}

/* ------------------ CORRECTION BUBBLE ------------------ */
function showCorrection(wrong, correctWord) {
    const box = document.getElementById("correctionBox");
    box.style.display = "block";
    box.innerHTML = `You said: <b>${wrong}</b><br>Correct pronunciation: <b>${correctWord}</b>`;
}

/* ------------------ PRONOUNCE WORD ------------------ */
function speakCorrectWord(word) {
    const utter = new SpeechSynthesisUtterance(word);
    utter.voice = speechSynthesis.getVoices().find(v =>
        v.lang === "en-US" && v.name.toLowerCase().includes("male")
    ) || speechSynthesis.getVoices()[0];
    speechSynthesis.speak(utter);
}

/* ------------------ NEXT SENTENCE ------------------ */
function moveToNextSentence() {
    document.getElementById("correctionBox").style.display = "none";
    currentIndex++;

    if (currentIndex >= sentences.length) {
        alert("Finished! Great work!");
        return;
    }

    updateProgress();
}

/* ------------------ PROGRESS BAR ------------------ */
function updateProgress() {
    const progress = (currentIndex / sentences.length) * 100;
    document.getElementById("progressBar").style.width = progress + "%";
}
</script>

</body>
</html>
